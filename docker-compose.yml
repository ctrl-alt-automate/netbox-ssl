# NetBox SSL Plugin - Development Environment
#
# Requires: netbox-docker 4.0.0+ (Granian, Valkey, PostgreSQL 18)
#
# Usage:
#   docker-compose up -d        # Start NetBox
#   docker-compose logs -f      # View logs
#   docker-compose down         # Stop everything
#
# First-time setup or after upgrade from 3.x:
#   docker-compose down -v      # Remove old volumes (destroys data!)
#   docker-compose up -d        # Fresh start with new stack

services:
  netbox: &netbox
    image: netboxcommunity/netbox:${NETBOX_VERSION:-v4.5-4.0.0}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      redis-cache:
        condition: service_healthy
    env_file: env/netbox.env
    healthcheck:
      test: curl -f http://localhost:8080/login/ || exit 1
      start_period: 90s
      timeout: 3s
      interval: 15s
    volumes:
      # Mount plugin source for development (hot-reload)
      - ./netbox_ssl:/opt/netbox/netbox/netbox_ssl:ro
      # Plugin configuration
      - ./development/configuration/plugins.py:/etc/netbox/config/plugins.py:ro
      # Media files
      - netbox-media-files:/opt/netbox/netbox/media
      # Reports and scripts
      - netbox-reports-files:/opt/netbox/netbox/reports
      - netbox-scripts-files:/opt/netbox/netbox/scripts
    ports:
      - "8000:8080"

  netbox-worker:
    <<: *netbox
    depends_on:
      netbox:
        condition: service_healthy
    command:
      - /opt/netbox/venv/bin/python
      - /opt/netbox/netbox/manage.py
      - rqworker
    healthcheck:
      test: ps -aux | grep -v grep | grep -q rqworker || exit 1
      start_period: 20s
      timeout: 3s
      interval: 15s
    ports: []

  netbox-housekeeping:
    <<: *netbox
    depends_on:
      netbox:
        condition: service_healthy
    command:
      - /opt/netbox/housekeeping.sh
    healthcheck:
      test: ps -aux | grep -v grep | grep -q housekeeping || exit 1
      start_period: 20s
      timeout: 3s
      interval: 15s
    ports: []

  postgres:
    image: postgres:18-alpine
    env_file: env/postgres.env
    volumes:
      - netbox-postgres-data:/var/lib/postgresql
    healthcheck:
      test: pg_isready -q -t 2 -d $$POSTGRES_DB -U $$POSTGRES_USER
      start_period: 20s
      timeout: 30s
      interval: 10s
      retries: 5

  redis:
    image: valkey/valkey:9.0-alpine
    command:
      - sh
      - -c
      - valkey-server --appendonly yes --requirepass $$REDIS_PASSWORD
    env_file: env/redis.env
    volumes:
      - netbox-redis-data:/data
    healthcheck: &valkey-healthcheck
      test: '[ "$$(valkey-cli --pass "$${REDIS_PASSWORD}" ping)" = "PONG" ]'
      start_period: 5s
      timeout: 3s
      interval: 1s
      retries: 5

  redis-cache:
    image: valkey/valkey:9.0-alpine
    command:
      - sh
      - -c
      - valkey-server --requirepass $$REDIS_PASSWORD
    env_file: env/redis-cache.env
    volumes:
      - netbox-redis-cache-data:/data
    healthcheck: *valkey-healthcheck

volumes:
  netbox-media-files:
  netbox-postgres-data:
  netbox-redis-data:
  netbox-redis-cache-data:
  netbox-reports-files:
  netbox-scripts-files:
